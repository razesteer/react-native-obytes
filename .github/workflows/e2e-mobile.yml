name: Expo Mobile E2E Tests (Maestro Local)

on:
  workflow_dispatch:

jobs:

  android-e2e:
    name: Android E2E (Maestro Local)
    runs-on: macos-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install PNPM + Dependencies
        run: |
          npm install -g pnpm
          pnpm install

      - name: Install Maestro
        run: pnpm run install-maestro

      - name: Load Env Variables
        run: |
          echo "EXPO_PUBLIC_APP_ENV=development" >> $GITHUB_ENV

      - name: Prebuild Native Projects
        run: pnpm prebuild:development

      - name: Build Android Debug APK
        run: |
          cd android
          ./gradlew assembleDebug
          cd ..

      - name: Start Emulator & Run Maestro
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: Nexus 6
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: |
            adb install android/app/build/outputs/apk/debug/app-debug.apk
            maestro test .maestro/ \
              -e APP_ID=com.obytes.development \
              --format html \
              --output maestro-android-report.html

      - name: Upload Android Report
        uses: actions/upload-artifact@v4
        with:
          name: maestro-android-report
          path: maestro-android-report.html


  ios-e2e:
    name: iOS E2E (Maestro Local via EAS Build)
    runs-on: macos-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install PNPM + Dependencies
        run: |
          npm install -g pnpm
          pnpm install

      - name: Install Maestro
        run: pnpm run install-maestro

      - name: Load Env Variables
        run: |
          echo "EXPO_PUBLIC_APP_ENV=development" >> $GITHUB_ENV

      - name: Build iOS via EAS
        run: |
          pnpm build:development:ios
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Download iOS IPA
        uses: actions/download-artifact@v3
        with:
          name: ios-build
          path: ios-app.ipa

      - name: Run Maestro on iOS Simulator
        run: |
          # This requires local Mac, may fail in CI runner without proper simulator setup
          xcrun simctl boot "iPhone 14" || true
          sleep 20
          maestro test .maestro/ \
            -e APP_ID=com.obytes.development \
            --format html \
            --output maestro-ios-report.html

      - name: Upload iOS Report
        uses: actions/upload-artifact@v4
        with:
          name: maestro-ios-report
          path: maestro-ios-report.html
